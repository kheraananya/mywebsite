{% extends "base.html" %} {% block title %} Dashboard {% endblock %} {% block
content %}
<script
	type="text/JavaScript"
	src=" https://MomentJS.com/downloads/moment.js"
></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@2.3.1/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.1.0/dist/chartjs-adapter-luxon.min.js"></script>
<h2 align="center" style="margin-top: 10px"><b>Dashboard</b></h2>
<div class>
	<div class="card card-style mb-2">
		<div class="card-body shadow">
			<div class="chart-container" style="position: relative">
				<canvas id="myChart1" width="400" height="400"></canvas>
			</div>
		</div>
	</div>
</div>
<div class>
	<div class="card card-style mb-2">
		<div class="card-body shadow">
			<div class="chart-container" style="position: relative">
				<form method="POST" action="/graph-settings">
					<select name="datebox" id="datebox">
						<option value="created"{% if prevdatetype == "created" %} selected {% endif %}>Date Created</option>
						<option value="assigned"{% if prevdatetype == "assigned" %} selected {% endif %}>Date Assigned</option>
					</select>
					&emsp;
					<label for="startdate">Start</label>
					<input type="date" id="startdate" name="startdate" value="{{prevstartdate}}"/>
					&emsp;
					<label for="enddate">End</label>
					<input type="date" id="enddate" name="enddate" value="{{prevenddate}}"/>
					&emsp;
					<select id="assignees" name="assignees" value="{{prevassignee}}">
						{% if user.usertype == 'assignee' %}
							<option value="{{user.username}}" selected>{{user.username}}</option>
						{% else %}
							<option value="" selected>All Assignees</option>
							{% for assignee in assignees %}
								<option value="{{assignee.username}}" {% if assignee.username == prevassignee %} selected {% endif %}>{{assignee.username}}</option>
							{% endfor %}
						{% endif %}
					</select>
					&emsp;
					<select id="reporters" name="reporters">
						{% if user.usertype == 'reporter' %}
							<option value="{{user.username}}" selected>{{user.username}}</option>
						{% else %}
						<option value="" selected>All Reporters</option>
							{% for reporter in reporters %}
								<option value="{{reporter.username}}"{% if reporter.username == prevreporter %} selected {% endif %}>{{reporter.username}}</option>
							{% endfor %}
						{% endif %}
					</select>
					&emsp;
					<button style="background-color: #003E7F; color: white;">Refresh</button>
				</form>
				<br>
				<canvas id="myChart2" width="400" height="400"></canvas>
			</div>
		</div>
	</div>
</div>
<script>
	   count_vs_status = JSON.parse( {{count_vs_status|tojson}} );
	      statuses =[];
	      counts=[];
	      for(ele of count_vs_status)
	      {
	          statuses.push(ele[1]);
	          counts.push(ele[0]);
	      }
	maxval = Math.max(...counts);
	stepSize = Math.ceil(maxval/5);
	   const ctx = document.getElementById('myChart1').getContext('2d');
	   const myChart1 = new Chart(ctx, {
	   type: 'bar',
	   data: {
	       labels: statuses,
	       datasets: [{
	           label: '# of Tickets',
	           data: counts,
	           borderWidth: 1,
	           backgroundColor: [
	            'rgba(255, 99, 132, 0.8)',
	            'rgba(54, 162, 235, 0.8)',
	            'rgba(255, 206, 86, 0.8)',
	            'rgba(75, 192, 192, 0.8)',
	            'rgba(153, 102, 255, 0.8)',
	            'rgba(255, 159, 64, 0.8)',
	            'rgba(255, 99, 132, 0.8)',
	            'rgba(54, 162, 235, 0.8)',
	            'rgba(255, 206, 86, 0.8)',
	            'rgba(75, 192, 192, 0.8)',
	            'rgba(153, 102, 255, 0.8)',
	            'rgba(255, 159, 64, 0.8)'
	          	],
			barPercentage: 0.5
	       }]
	   },
	   options: {
		plugins: {
			legend: {
				position: "right",
				labels: {
				generateLabels: (chart) => {
					const datasets = chart.data.datasets;
					return datasets[0].data.map((data, i) => ({
					text: `${chart.data.labels[i]} - ${data}`,
					fillStyle: datasets[0].backgroundColor[i],
					}))
				}
			}
	    		},
	          title: {
	              display: true,
	              text: "Summary Report for Ticket Count per Status"
	          }
	      },
	        legend: { display: true },
	        responsive: true,
	        maintainAspectRatio: true,
	        aspectRatio: 3,
	        scales: {
		y: {
			title: {
	        			display: true,
	        			text: 'Ticket Count'
	     	 		},
			min: 0,
			grace: '20%',
			beginAtZero:true,
			ticks:{
				stepSize:stepSize
			}
		},
		x:{
			title: {
	        			display: true,
	        			text: 'Status'
	     	 		}
		}
	},
	        tooltips: { enabled: true}
	   }
	});
</script>

<script>
	tickets_date_created = JSON.parse( {{tickets_date_created|tojson}} );
	dates =[];
	for(ele of tickets_date_created)
	{
		onlydate = ele[0].split(" ");
		date={x:onlydate[0],y:1};
	    dates.push(date);
	}
	const ctx2 = document.getElementById("myChart2");
	let updatedData =[];
	let tempDateCollection =[];
	minchart = moment().subtract(365, "days").format("DD/MM/YYYY");
	dates.map((yData , index)=> {
		yData.x = moment(yData.x, 'YYYY/MM/DD').format('DD/MM/YYYY');
		const formatedDate = moment(yData.x, 'DD/MM/YYYY').format('MMM/YYYY');
		if(tempDateCollection.includes(formatedDate))
		{
			const index = tempDateCollection.indexOf(formatedDate);
			const element = updatedData[index];
			updatedData[index] = {...element, y: element.y + yData.y}
		}
		else
		{
			tempDateCollection.push(formatedDate);
			updatedData.push(yData);
		}
	})
	const testsChart = new Chart(ctx2, {
		type: "bar",
		data: {
			datasets: [
				{
					label: '# of Tickets Created',
					data:updatedData,
					backgroundColor: [
	            'rgba(255, 99, 132, 0.8)',
	            'rgba(54, 162, 235, 0.8)',
	            'rgba(255, 206, 86, 0.8)',
	            'rgba(75, 192, 192, 0.8)',
	            'rgba(153, 102, 255, 0.8)',
	            'rgba(255, 159, 64, 0.8)',
	            'rgba(255, 99, 132, 0.8)',
	            'rgba(54, 162, 235, 0.8)',
	            'rgba(255, 206, 86, 0.8)',
	            'rgba(75, 192, 192, 0.8)',
	            'rgba(153, 102, 255, 0.8)',
	            'rgba(255, 159, 64, 0.8)'
	          		],
				},
			],
		},
		options: {
			plugins:{
				legend: {
				position: "right",
				labels: {
				generateLabels: (chart) => {
					const datasets = chart.data.datasets;
					return datasets[0].data.map((data, i) => ({
					text: `${moment(data.x, 'DD/MM/YYYY').format('MMM/YYYY')} - ${data.y}`,
					fillStyle: datasets[0].backgroundColor[i],
					}))
				}
			}
	    		},
				title: {
	              display: true,
	              text: "Summary Report of Tickets Created per Month"
	          }
			},
			maintainAspectRatio: true,
			aspectRatio: 3,
			scales: {
				x: {
					type: "time",
					time: {
						parser: "dd/MM/yyyy",
						unit: "month",
						tooltipFormat: "MM",
						round: 'month',
					},
				},
				y: {
					grace: '10%',
					ticks: {
						maxTicksLimit: 6,
    					precision: 0
					},
				},
			},
		},
	})
</script>

{% endblock %}
